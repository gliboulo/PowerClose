name: Build & Release Windows EXE (icon embedded)

on:
  release:
    types: [published]       # runs when you click “Publish release”
  push:
    tags:
      - "v*"                 # or when you push a tag like v1.0.0
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up MSYS2 (MinGW-w64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          install: >-
            base-devel
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-binutils

      - name: Build EXE (embed icon + link COM/Shell/UUID)
        shell: msys2 {0}
        run: |
          # Compile resource: RC -> COFF .res for 64-bit PE
          windres -O coff -F pe-x86-64 -i powerclose.rc -o appicon.res

          # Compile & link; remove -static if CRT issues on runner
          gcc -O2 -Wall -s -municode -o PowerClose.exe *.c appicon.res \
              -luser32 -lkernel32 -lole32 -lshell32 -luuid

      - name: Upload artifact (optional)
        uses: actions/upload-artifact@v4
        with:
          name: PowerClose.exe
          path: PowerClose.exe

  release:
    needs: build
    runs-on: windows-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Download built EXE
        uses: actions/download-artifact@v4
        with:
          name: PowerClose.exe
          path: .

      # If triggered by a tag push, ensure the release exists then upload
      - name: Create release if missing (tag push)
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          set TAG=${{ github.ref_name }}
          gh release view "%TAG%" --repo "${{ github.repository }}" || ^
            gh release create "%TAG%" --title "%TAG%" --notes "Automated build" --repo "${{ github.repository }}"
          gh release upload "%TAG%" PowerClose.exe --clobber --repo "${{ github.repository }}"

      # If triggered by publishing a release in the GUI, upload to it
      - name: Upload to published release (GUI)
        if: github.event_name == 'release'
        run: |
          set TAG=${{ github.event.release.tag_name }}
          gh release upload "%TAG%" PowerClose.exe --clobber --repo "${{ github.repository }}"
